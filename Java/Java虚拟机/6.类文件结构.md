# 类文件结构

## 概述

不同的操作系统对应的JVM支持统一的程序存储格式、字节码，使得Java可以运行是与平台无关的(平台无关性)。
实现无关性的基础是虚拟机和字节码存储结构。Java虚拟机只跟Class这种特定的二进制文件关联。而且上层的语言可以是任意的语言，只要编译出符合规范的Class文件(语言无关性)。

## Class类文件的结构

Class类文件是一组以8个字节为基础单位的二进制流。

如果需要8个字节以上空间的数据项时，会按照高位在前的方式分割成若干个8字节。

只存在"无符号数"和"表"

| 类型           | 名称                | 数量                  |
| -------------- | ------------------- | --------------------- |
| u4             | magic               | 1                     |
| u2             | minor_version       | 1                     |
| u2             | major_version       | 1                     |
| u2             | constant_pool_count | 1                     |
| cp_info        | constant_pool       | constant_pool_count-1 |
| u2             | access_flags        | 1                     |
| u2             | this_class          | 1                     |
| u2             | super_class         | 1                     |
| u2             | interfaces_count    | 1                     |
| u2             | interfaces          | interfaces_count      |
| u2             | fields_count        | 1                     |
| field_info     | fileds              | fields_count          |
| u2             | method_count        | 1                     |
| method_info    | methods             | method_count          |
| u2             | attributes_count    | 1                     |
| attribute_info | attributes          | attributes_count      |

### magic(魔数)与Class文件的版本

每个Class文件的开头4个字节为魔数。唯一作用是确定这个文件是否为能被虚拟机接受的Class文件

Class文件的魔数为0xCAFFVABABE

后面四个字节(minor_version和major_version)分别为次版本号和主版本号。高版本能兼容低版本，但不能运行后续版本的Class文件。

### 常量池

紧接着上述部分是常量池的入口。

常量池通常是占用空间最大的部分。

常量池的入口放置constant_pool_count，代表常量池容量计数值。容量计数从1开始，而不是0。0代表没有常量。

在类文件结构中只有常量池的计数是从1开始的。

常量池主要存放两大类常量：字面量和符号引用。

字面量一般是指文本字符串，被生命为final的常量值。

符号引用主要包括被模块导出或者开放的包，类和接口的全限定名，字段的名称和描述符，方法句柄和方法类型，动态调用点和动态常量。

constant_pool表结构的第一位是u1类型的标识位。代表当前变量属于哪种类型。

常量往往有两种，有可能直接就在结构中。类和接口的限定名往往指向另一个常量名。

### 访问标志

常量池后的2个字节代表访问标志，比如：这个Class是类还是接口，是否定义为public类型，是否为abstart，是类的话是否为final。

### 类索引、父类索引与接口索引集合

类索引和父类索引都是一个u2类型的数据，由于Java可以实现多个接口，因此接口索引是一个u2类型的集合。

Class文件由这三项来确认类型的继承关系。

除了java.lang.Object外，所有的Java类的父类索引都不为0。

接口索引集合，入口为u2类型的计数器，表示容量。如果没有实现接口，则计数器为0。后面的索引表不占用任何字节。

### 字段表集合

用于描述接口或者类中生命的变量。

字段包含的修饰符有

+ 字段作用域（public、private、protected）
+ 实例变量还是类变量（static修饰）

+ 是否可以被修改（final）

+ 并发可见性（volatile强制从主内存读写）
+ 能否被序列化（transient修饰符）
+ 字段数据类型（基本类型、对象、数组）
+ 字段名称

### 方法表集合

与字段表类似

依次包括访问标志、名称索引、描述符索引、属性表集合。

方法表中的Java代码，编译成字节码指令之后存放在方法属性表中名称为Code的属性里面。

Java中要重载一个方法，除了要与原方法具有相同的简单名称之外，还要求与其有不同的特征签名。

特征签名指的是一个方法中各个参数在常量池中的字段符号引用的集合。因此返回的参数类型是不在其中的。

### 属性表集合

Class文件、字段表、方法表都可以携带自己的属性表集合，用以描述某些场景特有的信息。

各种属性Todo...

### 字节码指令

Java虚拟机的指令由一个字节长度的、代表着某种特定操作含义的数字（操作码）以及后续0个或者多个操作数构成。

Java面向操作数栈，因此大多数指令都不包含操作数。

参数放在操作数栈中。（类似操作系统中的栈寻址）

操作码长度为一个字节（0～255）

指令的加载存储执行Todo...

